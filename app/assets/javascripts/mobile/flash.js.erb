$(document).delegate('.main_page', 'pageshow', function () {
  target = $(this).find('.flash_message').first();
  window.setTimeout(function(){
    target.on( "popupafterclose", function( event, ui ) {
      target.popup('destroy');
      target.remove();
    });
    if (!target.hasClass('flash_permenant')){
      target.on( "popupafteropen", function( event, ui ) {
        window.setTimeout(function() { 
          if (target.is(":visible")) {
            target.popup('close');            
          }
        }, 7000 );
      });  
    }
    target.popup("open");
  }, 300);  
});

$(document).on('click', '.flash_message', function () {
  $(this).popup('close');
});

function flashNow(message, message_type, popup_to_open_after_close) {
  message_type = message_type || 'notice';
  var flash_message = "<div class='center_wrap flash_message pa flash_" + message_type + "' role='dialog' data-position-to='window' data-transition='pop' data-overlay-theme='a'><p class='flash_message_content center' style='width:250px'></p><a role='button', data-icon='check', class='ui-btn ui-icon-check ui-btn-icon-left ui-shadow ui-corner-all ui-mini mt'>OK</a></div>";
  if ($.mobile.activePage) {
    $.mobile.activePage.find('.flash_message').remove();
    $.mobile.activePage.prepend(flash_message);
    var target = $.mobile.activePage.find('.flash_message');
    target.find('.flash_message_content').html(message);    
    target.on('popupafterclose', function() {
      target.remove();
      if (popup_to_open_after_close) {
        window.setTimeout(function() { popup_to_open_after_close.popup('open'); }, 500 ); 
      }
    });      
    target.on( "popupafteropen", function( event, ui ) {
      window.setTimeout(function() { 
        if (target.is(":visible")) {
          target.popup('close');
          target.popup('destroy');
          target.remove();
        }
      }, 7000 ); 
    });
    target.popup().popup("open");
  }
}