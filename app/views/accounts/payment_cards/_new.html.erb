<div id="add_payment_card_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="new_card_modal" aria-hidden="true">
  
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3 id="myModalLabel">Add a Payment Card</h3>
  </div>  
  
  <div class="modal-body">
    <div id='new_card_inputs'>
      <input type="text" name="name_on_card" autocomplete="off" placeholder='Cardholder Name' <%= "value=Bob" unless Rails.env.production? %> />
      <input type="text" name="card_number" <%= "value=4111111111111111" unless Rails.env.production? %> autocomplete="off" placeholder='Card Number' />
      <div>
        <select type="select"  name="expiration_month" value="1">
          <% 12.times do |index| %>
            <%= "<option value=\'#{index+1}\'>#{index+1}</option>".html_safe %>
          <% end %>
        </select>
      </div> 
      <div>
        <select type="select"  name="expiration_year" selected="2020">
          <% 10.times do |index| %>
            <% year = index + Time.now.year %>
            <%= "<option value=\'#{year}\' #{"selected=\'selected\'" unless (Rails.env.production? or year != 2020)} >#{year}</option>".html_safe %>
          <% end %>
        </select>
      </div>      
      <div>
        <input type="text"  name="security_code" placeholder='XXX' autocomplete="off" <%= "value=123" unless Rails.env.production? %> />
      </div>
      <div>
        <input type="text"  name="zip_code" placeholder='XXXXX' autocomplete="off" <%= "value=12345" unless Rails.env.production? %> /> 
      </div>
      <% if user_signed_in? %>
        <div>
          <select name='remember_card'>
            <option value='false'>No</option>
            <option value='true' selected='selected'>Yes</option>
          </select>                    
        </div>
      <% end %>          
    </div>      
  </div>
  
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button id='payment_card_submit' class='btn btn-primary'>Validate Card</button>            
  </div>

</div>

<%= form_for Accounts::PaymentCard.new(params[:accounts_payment_card]), :method => :post do |f| %>
  <%= f.hidden_field :balanced_uri %>
<% end %>

<script type="text/javascript" src="https://js.balancedpayments.com/v1/balanced.js"></script>
<script type="text/javascript">

  var marketplaceUri = '<%= ENV['BALANCED_MARKETPLACE_URI'] %>';
 
  var debug = function (tag, content) {
     console.log('<' + tag + '>' + content + '</' + tag + '>');
  };
 
  var tokenizeCard = function( $form ) {

    try {
      balanced.init(marketplaceUri);
    } catch (e) {
      debug('code', 'You need to set the marketplaceUri variable');
    }

    var cardData = {
      name: $form.find('[name="name_on_card"]').val(),            
      card_number: $form.find('[name="card_number"]').val(),
      expiration_month: $form.find('[name="expiration_month"]').val(),
      expiration_year: $form.find('[name="expiration_year"]').val(),
      security_code: $form.find('[name="security_code"]').val(),
      postal_code: $form.find('[name="postal_code"]').val(),
    }; 

    balanced.card.create(cardData, <%= defined?(callback_function) ? callback_function : 'balancedAddCardCallback' %>);
  };

  $('#payment_card_submit').click(function(e){
    e.preventDefault();
    var new_card_popup = $(this).closest("[role='dialog']");
    var is_all_data_populated = true;
    $.each(new_card_popup.find('input'), function(){
      if (!$(this).val()) {
        is_all_data_populated = false;
      }
    });
    if (is_all_data_populated) {
      new_card_popup.modal('hide');
      tokenizeCard($('#new_card_inputs'));
    } else {
      new_card_popup.modal('hide');
      flashNow('Please completely fill out card information', 'error', new_card_popup);
      window.setTimeout(function() {
        new_card_popup.modal('show');
      }, 2000);      
      
    }    
  });

</script>