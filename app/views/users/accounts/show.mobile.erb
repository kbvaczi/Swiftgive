<%= render :partial => 'users/accounts/edit_location', :formats => [:mobile] %>
<%= render :partial => 'users/payment_cards/new', :formats => [:mobile], :locals => {:callback_function => 'balancedAddCardToProfileCallback'} %>

<ul data-role="listview" data-inset="true" data-theme"a">
  <li data-role="list-divider" data-theme='a'>My Profile</li>  
    <li>
      <div class='ui-grid-a'>
        <div class='ui-block-a side'>
          <% if current_user.image.present? %>
            <%= image_tag current_user.image, :height => '80px', :width => '80px' %>
          <% else %>
            <div style='height:80px;width:80px'>Add Image</div>
          <% end %>
        </div>
        <div class='ui-block-b ui-block-c main'>
          <h3><%= current_user.full_name %></h3>
          <p><%= current_user.email %></p>
          <% if current_user.phone_number.present? %>
            <p><%= current_user.phone_number %></p>
          <% else %>
            <p><i>no phone number</i></p>
          <% end %>
        </div>          
      </div>
    </li>

    <li data-icon='gear'>
      
        <% if current_user.city.present? and current_user.state.present? and current_user.postal_code.present? %>
          <a href="#account_edit_location" data-rel="popup" data-position-to="window">
            <div class='mt-m'>
              <p><b><%= current_user.street_address %></b></p>
              <p><%= current_user.city %>, <%= current_user.state %> <%= current_user.postal_code %></p>        
              <p><%= current_user.country %></p>
            </div>
          </a>
        <% else %>          
          <a href="#account_edit_location" data-rel="popup" data-position-to="window">Setup Location Info</a>
        <% end %>
    </li>

  </li>
  <li data-role="list-divider" data-theme='a'>Payment Cards</li>  
    <% current_user.payment_cards.each do |payment_card| %>
      <li data-icon='delete'><%= link_to "#{payment_card.card_type} ending in #{payment_card.last_4_digits}", users_payment_card_path(payment_card), :method => :delete, :confirm => 'are you sure you want to delete this card?' %> </li>         
    <% end %> 
    <li data-icon='plus'>
      <a href="#new_payment_card_form" data-rel="popup" data-position-to="window">Add a payment card</a>
      <%= form_for Users::PaymentCard.new(params[:payment_card]), :method => :post do |f| %>
        <%= f.hidden_field :uri %>
      <% end %>
    </li>
  </li>

  <li data-role="list-divider" data-theme='a'>Social Networks Linked</li>  
    <li>
      <div class='center_wrap'>
        <% current_user.authentications.each do |authentication| %>
          <%= image_tag('facebook.png', :width => '50px', :height => '50px') if authentication.provider_name == 'Facebook' %>
          <%= image_tag('google.png', :width => '50px', :height => '50px') if authentication.provider_name == 'Google' %>
          <%= image_tag('linkedin.png', :width => '50px', :height => '50px') if authentication.provider_name == 'LinkedIn' %>      
        <% end %>
      </div>
    </li>
  </li>
</ul>


<script type='text/javascript'>

  function balancedAddCardToProfileCallback(response) {
    var tag = (response.status < 300) ? 'pre' : 'code';
    debug(tag, JSON.stringify(response));
    switch (response.status) {
      case 201:
        //createPaymentCard(response.data.uri); // No Longer handling this via ajax
        $.mobile.activePage.find("#new_payment_card_form").popup("close");
        $.mobile.activePage.find("input[name='users_payment_card[uri]']").val(response.data.uri);
        $.mobile.activePage.find('form#new_users_payment_card').submit();
        break;
      case 400:
      case 403: // missing/malformed data - check response.error for details
        $.mobile.activePage.find("#new_payment_card_form").popup("close");
        var error_message = '<h3>Could not validate your card</h3>';
        $.each( response.error, function( key, value ) {
          error_message += ( key + ": " + "is not valid" + "<br/>");
        });
        error_message += "<p>Please try again...</p>";
        window.setTimeout ( function() {                  
          flashNow(error_message, 'error');
        }, 1000 );
        break;               
      case 402: // we couldn't authorize the buyer's credit card - check response.error for details
        $.mobile.activePage.find("#new_payment_card_form").popup("close");
        var error_message = '<h3>Could not validate your card</h3><p>The card entered was declined</p><p>Please try another card...</p>';
        window.setTimeout ( function() {                  
          flashNow(error_message, 'error');
        }, 1000 );
        break;
      case 404: // your marketplace URI is incorrect
        break;
      default: // we did something unexpected - check response.error for details
        break;
    }
  }

var createPaymentCard = function( payment_card_uri ) {
  var path = "<%= payment_cards_path %>";
  var params = [{ name: 'format',            value: 'json' },
                { name: 'skip_mobile',       value: 'true' },
                { name: 'payment_card[uri]', value: payment_card_uri }];
  var url = path + '?' + $.param(params);  
  $.ajax({
    url: url,
    type: "POST",
    dataType: "JSON",
    beforeSend: function ( xhr ) {

    },
    error: function (xhr, ajaxOptions, thrownError) {
      flashNow('Oops! There was an error...');
    },
    success: function(data) {      
      window.setTimeout(function() {                  
        flashNow('Your card was successfully validated', 'notice');
      }, 1000 );
    }
  });
}

</script>